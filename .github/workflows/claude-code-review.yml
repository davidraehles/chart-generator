name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feature/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: Automated Code Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
            **/*.py
          separator: "\n"

      - name: Run ESLint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            cd frontend
            npm ci --quiet
            echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -E '\.(ts|tsx|js|jsx)$' | xargs -r npx eslint --format stylish || true
          fi

      - name: Run Python linting
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          if [ -d "backend" ]; then
            pip install ruff --quiet
            echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -E '\.py$' | xargs -r ruff check || true
          fi

      - name: Post review summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedFilesRaw = `${{ steps.changed-files.outputs.all_changed_files }}`;
            const fileCount = changedFilesRaw ? changedFilesRaw.split('\n').filter(f => f.trim()).length : 0;
            
            const reviewComment = [
              '## üîç Automated Code Review',
              '',
              `**Files analyzed:** ${fileCount} source files`,
              '',
              '**Checks performed:**',
              '- ESLint for TypeScript/JavaScript files',
              '- Ruff for Python files',
              '',
              '**Review Focus Areas:**',
              '- TypeScript type safety',
              '- React/Next.js best practices',
              '- Python code quality',
              '- Security patterns',
              '',
              'Check the workflow logs for detailed linting results.'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });
