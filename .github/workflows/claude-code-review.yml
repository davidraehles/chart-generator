name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feature/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: Automated Code Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          separator: ","

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Check API Key
        id: check-key
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "api_key_exists=false" >> $GITHUB_OUTPUT
          else
            echo "api_key_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Claude Code Review
        if: steps.check-key.outputs.api_key_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          python .github/scripts/claude_review.py

      - name: API Key Missing Notice
        if: steps.check-key.outputs.api_key_exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ⚠️ Claude Code Review - Setup Required

            The Claude code review workflow is configured but cannot run because the \`ANTHROPIC_API_KEY\` secret is not set.

            **To enable automated Claude code reviews:**

            1. Get an API key from [Anthropic Console](https://console.anthropic.com/)
            2. Go to **Settings** → **Secrets and variables** → **Actions**
            3. Click **New repository secret**
            4. Name: \`ANTHROPIC_API_KEY\`
            5. Value: Your Anthropic API key
            6. Click **Add secret**

            Once the secret is added, future pull requests will automatically receive Claude code reviews.

            **Manual Review Available:**
            You can still use the custom Claude agents manually:
            - \`/agent hd-domain-expert\` - Human Design domain validation
            - \`/agent api-integration-specialist\` - API integration review
            - \`/agent chart-visualization-specialist\` - Bodygraph SVG review
            - \`/agent spec-compliance-agent\` - Specification compliance check

            See \`.github/scripts/README.md\` for full setup instructions.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Run ESLint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            cd frontend
            npm ci --quiet
            # Safely handle file paths to prevent command injection
            changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
            if [ -n "$changed_files" ]; then
              IFS=',' read -ra FILES <<< "$changed_files"
              for file in "${FILES[@]}"; do
                # Validate file exists and matches expected pattern
                if [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]] && [ -f "$file" ]; then
                  npx eslint --format stylish "$file" || true
                fi
              done
            fi
          fi

      - name: Run Python linting
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          if [ -d "backend" ]; then
            pip install ruff --quiet
            # Safely handle file paths to prevent command injection
            changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
            if [ -n "$changed_files" ]; then
              IFS=',' read -ra FILES <<< "$changed_files"
              for file in "${FILES[@]}"; do
                # Validate file exists and matches expected pattern
                if [[ "$file" =~ \.py$ ]] && [ -f "$file" ]; then
                  ruff check "$file" || true
                fi
              done
            fi
          fi

      - name: Post review summary
        if: steps.check-key.outputs.api_key_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedFilesRaw = `${{ steps.changed-files.outputs.all_changed_files }}`;
            const fileCount = changedFilesRaw ? changedFilesRaw.split(',').filter(f => f.trim()).length : 0;
            
            const reviewComment = [
              '## ✅ Claude Code Review Complete',
              '',
              'Claude has analyzed the changes in this PR.',
              '',
              `**Files analyzed:** ${fileCount} source files`,
              '',
              '**Review Focus:**',
              '- TypeScript & Next.js best practices',
              '- Human Design domain accuracy',
              '- Mobile-first responsive design (375px+)',
              '- German language validation',
              '- Security & performance',
              '- Specification compliance (specs/001-hd-chart-generator/)',
              '',
              '**Custom Agents Available:**',
              '- HD Domain Expert',
              '- API Integration Specialist',
              '- Chart Visualization Specialist',
              '- Specification Compliance Agent',
              '',
              'Check the review comments above for detailed feedback.'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });
